version: '2'

services:
    #php
    php-medzoner:
        image: "medzoner/medzoner_php:7.0"
        container_name: "php-medzoner"
        working_dir: "${PATHBASE}"
        restart: "always"
        environment:
          USER_UID: "${USER_UID}"
          USER_GID: "${USER_GID}"
          XDEBUG_CONFIG: "remote_host=${XDEBUG_CONFIG_HOST} remote_port=${XDEBUG_CONFIG_PORT}"
          PHP_IDE_CONFIG: "serverName=${PHP_IDE_CONFIG}"
        volumes:
            - "${PATH_PROJECT}:/var/www/medzoner"
            # ssh git auth
            - "$SSH_AUTH_SOCK:/ssh-agent"
            - "~/.ssh/id_rsa:/home/www-data/private_key"
            # bitbucket auth
            - "${HOME_PATH}/.ssh:/home/www-data/.ssh"
            - "${HOME_PATH}/.composer:/home/www-data/.composer"
            # php conf by env
            - "./etc/php/7.0/php.${STAGING_ENV}.ini:/usr/local/etc/php/conf.d/php.ini"
            - "./etc/php/7.0/xdebug.ini:/usr/local/etc/php/conf.d/xdebug.ini"
            - "./etc/php/7.0/php-fpm.d/docker.conf:/usr/local/etc/php-fpm.d/docker.conf"
        networks:
          medzoner:
            aliases:
              - "php-medzoner"
        extra_hosts:
         - "medzoner.dev:172.19.0.1"

    #nginx
    nginx-medzoner:
        image: "medzoner/medzoner_nginx"
        container_name: "nginx-medzoner"
        working_dir: "${PATHBASE}"
        restart: "always"
        ports:
            - "${HTTP_PORT}:80"
        volumes:
            - "${PATH_PROJECT}:/var/www/medzoner"
            # nginx vhost by env
            - "./etc/nginx/conf.d/default.${STAGING_ENV}.conf:/etc/nginx/conf.d/default.conf"
            - "./etc/nginx/nginx.conf:/etc/nginx/nginx.conf"
        networks:
          medzoner:
            aliases:
              - "nginx-medzoner"

    #mysql
    mysql-medzoner:
        image: "mariadb"
        container_name: "mysql-medzoner"
        restart: "always"
        environment:
            MYSQL_ROOT_PASSWORD: "${MYSQL_ROOT_PASSWORD}"
        volumes:
            - "${MYSQL_PATH}:/var/lib/mysql"
        ports:
            - "3361:3306"
        networks:
          medzoner:
            aliases:
              - "mysql-medzoner"

    #redis
    redis-medzoner:
        image: "redis:alpine"
        container_name: "redis-medzoner"
        restart: "always"
        networks:
          medzoner:
            aliases:
              - "redis-medzoner"

networks:
    medzoner:
        driver: "bridge"
        ipam:
            driver: "default"
            config:
                - subnet: "172.61.0.0/24"
volumes:
    db: {}
